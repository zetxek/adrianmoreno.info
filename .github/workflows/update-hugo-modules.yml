name: Update Hugo modules

# Controls when the action will run.
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      run_go_mod_tidy:
        description: 'Run go mod tidy before verification'
        required: false
        type: boolean
        default: false

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Run go mod tidy
        if: ${{ inputs.run_go_mod_tidy }}
        run: go mod tidy

      - name: Update Hugo Modules
        run: |
          DATE=$(date '+%Y%m%d-%H%M')
          BRANCH_NAME="update-hugo-modules/update-$DATE"
          
          # Setup the committer's identity
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions - update Hugo modules"
          
          # Create new branch
          git checkout -b $BRANCH_NAME
          
          # Capture theme version before update
          OLD_THEME_VERSION=$(grep 'zetxek/adritian-free-hugo-theme' go.mod | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+[^ ]*' || echo "unknown")

          # Update Hugo modules
          hugo mod get -u
          hugo mod tidy

          # Capture theme version after update
          NEW_THEME_VERSION=$(grep 'zetxek/adritian-free-hugo-theme' go.mod | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+[^ ]*' || echo "unknown")

          # Commit changes if any
          if [[ -n $(git status -s) ]]; then
            git add go.mod go.sum
            git commit -m "chore: update Hugo modules (theme ${OLD_THEME_VERSION} -> ${NEW_THEME_VERSION})"
            git push origin $BRANCH_NAME

            # Get the updated module versions for PR description
            UPDATES=$(git diff origin/main...HEAD go.mod | grep -E '^\+.*v[0-9]' || echo "No version changes found")

            # Build PR title
            if [[ "$OLD_THEME_VERSION" != "$NEW_THEME_VERSION" ]]; then
              PR_TITLE="chore: update adritian-free-hugo-theme ${OLD_THEME_VERSION} -> ${NEW_THEME_VERSION}"
            else
              PR_TITLE="chore: update Hugo modules"
            fi

            # Create PR
            gh pr create \
              -B main \
              -H $BRANCH_NAME \
              --title "$PR_TITLE" \
              --body $'ðŸ¤– This automated PR updates the Hugo modules to their latest versions.\n\nChanges in go.mod:\n```\n'"$UPDATES"$'\n```\n\nðŸ”— Triggered by GitHub action: https://github.com/'"$GITHUB_REPOSITORY"$'/actions/workflows/update-hugo-modules.yml'
          else
            echo "No updates found for Hugo modules"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
